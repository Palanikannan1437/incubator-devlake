tasks:
  - name: open-frontend-preview
    command: |
      gp ports 8080 && gp preview $(gp url 4000) 
      exit

  - name: Install mysql and grafana
    init: |
      docker pull mysql:8
      docker pull mericodev/devlake-dashboard:latest
      docker pull mericodev/devlake:latest
    command: |
      gp sync-done init_docker_containers
      echo "MySQL and Grafana downloaded ðŸš€"
      exit

  - name: start backend
    env:
      PKG_CONFIG_PATH: ":/usr/local/lib:/usr/local/lib/pkgconfig"
      LD_LIBRARY_PATH: ":/usr/local/lib"
    init: go get
    command: |
      cp .env.example .env &&
      sed -i'' '/^DB_URL=/s#=.*#=mysql://merico:merico@127.0.0.1:3306/lake?charset=utf8mb4\&parseTime=True#' .env &&
      sed -i'' '/^E2E_DB_URL=/s#=.*#=mysql://merico:merico@127.0.0.1:3306/lake_test?charset=utf8mb4\&parseTime=True#' .env &&
      gp sync-await init_docker_containers &&
      docker-compose up -d mysql grafana &&
      make dev

  - name: start frontend
    init: |
      cd config-ui
      nvm use 14.21.0 && npm install
      cd ../
    command: |
      cd config-ui
      nvm use 14.21.0 && npm start

ports:
  - port: 8080
    onOpen: ignore
    name: devlake-api
    visibility: public
  - port: 4000
    onOpen: ignore
    name: devlake-ui
    visibility: public
  - port: 3306
    onOpen: ignore
  - port: 3002
    onOpen: ignore

github:
  prebuilds:
    master: true
    branches: true
    pullRequests: true
    pullRequestsFromForks: true
    addCheck: true
    addComment: true
    addBadge: true

image:
  file: .gitpod.dockerfile

vscode:
  extensions:
    - golang.go